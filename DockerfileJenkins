#
# Build stage
#

FROM ubuntu:16.04

RUN apt-get update && apt-get install -y \
  build-essential \
  git \
  openjdk-8-jdk \
  maven \
  nginx \
  curl

RUN curl -sL https://deb.nodesource.com/setup_14.x | bash - \
  && apt-get install -y nodejs 

RUN rm -rf capstone-project
RUN git clone https://github.com/sandycaltechpgp/capstone-project.git

RUN cp -R capstone-project/backend-app /home/be

WORKDIR /home/be/

RUN mvn clean install -DskipTests

RUN cp /home/be/backend-app/target/*.jar /usr/local/lib/demo.jar

RUN cp -R capstone-project/front-end-app /home/fe


WORKDIR /home/fe
RUN npm install
RUN npm run ng build -- --prod --configuration=docker  --verbose --progress=true

RUN cp -R  /home/fe/dist/shopping-app/  /usr/share/nginx/html/

RUN rm -v /etc/nginx/nginx.conf

# Copy a configuration file from the current directory
ADD capstone-project/nginx.conf /etc/nginx/


EXPOSE 8087
EXPOSE 80


WORKDIR /usr/local/lib
ENTRYPOINT sh -c 'service nginx start && java -jar -Dspring.profiles.active=devh2 /usr/local/lib/demo.jar'
